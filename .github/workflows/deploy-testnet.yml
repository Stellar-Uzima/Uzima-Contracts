name: Deploy to Testnet

on:
  push:
    branches: [ develop ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      contract:
        description: 'Contract to deploy (leave empty for all)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

env:
  RUST_VERSION: "1.92.0"
  SOROBAN_VERSION: "23.1.4"
  NETWORK: "testnet"

jobs:
  # Run comprehensive tests
  pre-deploy-tests:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    if: inputs.skip_tests != true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev

      - name: Install Soroban CLI
        run: |
          curl -L -o stellar-cli.tar.gz https://github.com/stellar/soroban-cli/releases/download/v${{ env.SOROBAN_VERSION }}/stellar-cli-${{ env.SOROBAN_VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli.tar.gz
          sudo mv stellar /usr/local/bin/soroban
          rm stellar-cli.tar.gz

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run all tests
        run: cargo test --all

  # Build contracts
  build:
    name: Build Contracts
    runs-on: ubuntu-latest
    needs: [pre-deploy-tests]
    if: always() && (needs.pre-deploy-tests.result == 'success' || inputs.skip_tests == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev

      - name: Install Soroban CLI
        run: |
          curl -L -o stellar-cli.tar.gz https://github.com/stellar/soroban-cli/releases/download/v${{ env.SOROBAN_VERSION }}/stellar-cli-${{ env.SOROBAN_VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli.tar.gz
          sudo mv stellar /usr/local/bin/soroban
          rm stellar-cli.tar.gz

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build optimized contracts
        run: |
          mkdir -p dist
          for contract in contracts/*/; do
            if [ -d "$contract" ]; then
              contract_name=$(basename "$contract")
              echo "Building contract: $contract_name"
              cd "$contract"
              cargo build --target wasm32-unknown-unknown --release
              cd - > /dev/null
              
              wasm_file="$contract/target/wasm32-unknown-unknown/release/${contract_name}.wasm"
              if [ -f "$wasm_file" ]; then
                cp "$wasm_file" "dist/${contract_name}.wasm"
                echo "Copied: ${contract_name}.wasm"
              fi
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-contracts-testnet
          path: dist/*.wasm
          retention-days: 7

  # Deploy to testnet
  deploy:
    name: Deploy to Testnet
    runs-on: ubuntu-latest
    needs: [build]
    environment:
      name: testnet
      url: https://soroban-testnet.stellar.org
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev

      - name: Install Soroban CLI
        run: |
          curl -L -o stellar-cli.tar.gz https://github.com/stellar/soroban-cli/releases/download/v${{ env.SOROBAN_VERSION }}/stellar-cli-${{ env.SOROBAN_VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli.tar.gz
          sudo mv stellar /usr/local/bin/soroban
          rm stellar-cli.tar.gz

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-contracts-testnet
          path: dist/

      - name: Configure Soroban network
        run: |
          soroban config network add testnet \
            --rpc-url https://soroban-testnet.stellar.org:443 \
            --network-passphrase "Test SDF Network ; September 2015" || true

      - name: Setup deployment identity
        env:
          SOROBAN_SECRET_KEY: ${{ secrets.TESTNET_DEPLOYER_SECRET_KEY }}
        run: |
          if [ -z "$SOROBAN_SECRET_KEY" ]; then
            echo "Generating new identity for testnet..."
            soroban config identity generate deployer-testnet
          else
            echo "$SOROBAN_SECRET_KEY" > /tmp/secret_key.txt
            soroban config identity add deployer-testnet --secret-key /tmp/secret_key.txt
            rm -f /tmp/secret_key.txt
          fi

      - name: Deploy contracts
        id: deploy
        run: |
          mkdir -p deployments
          deployment_log="deployments/testnet_$(date +%Y%m%d_%H%M%S).json"
          echo "[]" > "$deployment_log"
          
          if [ -n "${{ inputs.contract }}" ]; then
            contracts="${{ inputs.contract }}"
          else
            contracts=$(ls -d contracts/*/ | xargs -n1 basename)
          fi
          
          for contract_name in $contracts; do
            wasm_file="dist/${contract_name}.wasm"
            if [ ! -f "$wasm_file" ]; then
              echo "Warning: $wasm_file not found, skipping"
              continue
            fi
            
            echo "Deploying $contract_name to TESTNET..."
            
            contract_id=$(soroban contract deploy \
              --wasm "$wasm_file" \
              --source deployer-testnet \
              --network testnet \
              --output json | jq -r '.contract_id' || echo "")
            
            if [ -z "$contract_id" ] || [ "$contract_id" = "null" ]; then
              echo "Error: Failed to deploy $contract_name"
              exit 1
            fi
            
            echo "âœ… Deployed $contract_name: $contract_id"
            
            jq --arg name "$contract_name" \
               --arg id "$contract_id" \
               --arg network "testnet" \
               --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
               --arg commit "${{ github.sha }}" \
               '. += [{
                 "contract_name": $name,
                 "contract_id": $id,
                 "network": $network,
                 "deployed_at": $timestamp,
                 "commit_sha": $commit,
                 "deployer": "deployer-testnet"
               }]' "$deployment_log" > "${deployment_log}.tmp" && mv "${deployment_log}.tmp" "$deployment_log"
          done
          
          echo "deployment_log=$deployment_log" >> $GITHUB_OUTPUT

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info-testnet
          path: deployments/*.json
          retention-days: 90