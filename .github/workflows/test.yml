name: CI - Test and Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  RUST_VERSION: "1.92.0"
  SOROBAN_VERSION: "23.1.4"
  CARGO_TERM_COLOR: always

jobs:
  # 1. Format Check
  fmt:
    name: Code Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # 2. Linting (Clippy)
  clippy:
    name: Linting (Clippy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # 3. Unit Tests (Named test-unit)
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run unit tests
        run: cargo test --lib --all

  # 4. Integration Tests (Named test-integration)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev

      - name: Install Soroban CLI
        run: |
          curl -L -o stellar-cli.tar.gz https://github.com/stellar/soroban-cli/releases/download/v${{ env.SOROBAN_VERSION }}/stellar-cli-${{ env.SOROBAN_VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli.tar.gz
          sudo mv stellar /usr/local/bin/soroban
          rm stellar-cli.tar.gz

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run integration tests
        run: cargo test --test '*' --all

  # 5. Build Contracts
  build:
    name: Build Contracts
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev

      - name: Install Soroban CLI
        run: |
          curl -L -o stellar-cli.tar.gz https://github.com/stellar/soroban-cli/releases/download/v${{ env.SOROBAN_VERSION }}/stellar-cli-${{ env.SOROBAN_VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli.tar.gz
          sudo mv stellar /usr/local/bin/soroban
          rm stellar-cli.tar.gz

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build optimized contracts
        run: |
          for contract in contracts/*/; do
            if [ -d "$contract" ]; then
              contract_name=$(basename "$contract")
              echo "Building contract: $contract_name"
              cd "$contract"
              cargo build --target wasm32-unknown-unknown --release
              cd - > /dev/null
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-contracts
          path: |
            contracts/*/target/wasm32-unknown-unknown/release/*.wasm
          retention-days: 7

  # 6. Test Summary (Matches job names perfectly)
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration, build, fmt, clippy]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.test-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.fmt.result }}" != "success" ] || \
             [ "${{ needs.clippy.result }}" != "success" ]; then
            echo "❌ Tests or Checks Failed"
            exit 1
          fi
          echo "✅ All checks passed!"